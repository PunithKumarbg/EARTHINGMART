<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buyer | Light Connect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4 text-primary">💡 Buyer Dashboard</h2>

  <!-- Login/Register Section -->
  <div id="authSection" class="card p-4 mb-4 shadow-sm">
    <h5 class="mb-3 text-center">Login or Register</h5>
    <div class="mb-3">
      <input type="email" id="buyerEmail" class="form-control" placeholder="Email">
    </div>
    <div class="mb-3">
      <input type="password" id="buyerPassword" class="form-control" placeholder="Password">
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="buyerLogin()">Login</button>
      <button class="btn btn-outline-primary" onclick="buyerRegister()">Register</button>
    </div>
  </div>

  <!-- Request Form -->
  <div id="requestSection" class="card p-4 mb-4 d-none shadow-sm">
    <h5 class="mb-3">New Product Request</h5>
    <div class="mb-3">
      <input type="text" id="productName" class="form-control" placeholder="Product name">
    </div>
    <div class="mb-3">
      <input type="number" id="productQty" class="form-control" placeholder="Quantity">
    </div>
    <div class="mb-3">
      <input type="text" id="deliveryCity" class="form-control" placeholder="Delivery city">
    </div>
    <div class="d-grid">
      <button class="btn btn-success" onclick="submitRequest()">Submit Request</button>
    </div>
    <div class="text-end mt-3">
      <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Requests Table -->
  <div id="myRequests" class="card p-4 d-none shadow-sm">
    <h5>My Requests</h5>
    <table class="table table-striped mt-3">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>City</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="requestsTable"></tbody>
    </table>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="../firebase-config.js"></script>

<script>
let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('authSection').classList.add('d-none');
    document.getElementById('requestSection').classList.remove('d-none');
    document.getElementById('myRequests').classList.remove('d-none');
    loadRequests();
  } else {
    currentUser = null;
    document.getElementById('authSection').classList.remove('d-none');
    document.getElementById('requestSection').classList.add('d-none');
    document.getElementById('myRequests').classList.add('d-none');
  }
});

function buyerRegister() {
  const email = buyerEmail.value;
  const pass = buyerPassword.value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(() => alert('✅ Registered Successfully'))
    .catch(err => alert(err.message));
}

function buyerLogin() {
  const email = buyerEmail.value;
  const pass = buyerPassword.value;
  auth.signInWithEmailAndPassword(email, pass)
    .then(() => console.log('Logged In'))
    .catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

function submitRequest() {
  const product = productName.value.trim();
  const qty = productQty.value.trim();
  const city = deliveryCity.value.trim();

  if (!product || !qty || !city) {
    alert('⚠️ Please fill all fields');
    return;
  }

  db.collection('requests').add({
    buyerId: currentUser.uid,
    product,
    qty,
    city,
    status: 'Pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    productName.value = '';
    productQty.value = '';
    deliveryCity.value = '';
    alert('✅ Request submitted');
  });
}

function loadRequests() {
  db.collection('requests')
    .where('buyerId', '==', currentUser.uid)
    .orderBy('createdAt', 'desc')
    .onSnapshot(snapshot => {
      const tbody = document.getElementById('requestsTable');
      tbody.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        tbody.innerHTML += `
          <tr>
            <td>${data.product}</td>
            <td>${data.qty}</td>
            <td>${data.city}</td>
            <td>${data.status}</td>
          </tr>
        `;
      });
    });
}
</script>

</body>
</html>
