<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buyer | Light Connect</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4 text-primary">ðŸ›’ Buyer Dashboard</h2>

  <!-- Login/Register -->
  <div id="authSection" class="card p-4 mb-4 shadow-sm">
    <input type="email" id="buyerEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="buyerPassword" class="form-control mb-2" placeholder="Password">
    <div class="d-grid gap-2">
      <button class="btn btn-primary" onclick="buyerLogin()">Login</button>
      <button class="btn btn-outline-primary" onclick="buyerRegister()">Register</button>
    </div>
  </div>

  <!-- Submit Request -->
  <div id="requestSection" class="card p-4 mb-4 d-none shadow-sm">
    <h5>Submit a Request</h5>
    <input type="text" id="reqProduct" class="form-control mb-2" placeholder="Product Name">
    <input type="number" id="reqQty" class="form-control mb-2" placeholder="Quantity">
    <input type="text" id="reqCity" class="form-control mb-2" placeholder="City">
    <button class="btn btn-success" onclick="submitRequest()">Submit Request</button>
    <button class="btn btn-sm btn-danger mt-2" onclick="logout()">Logout</button>
  </div>

  <!-- My Requests -->
  <div id="myRequests" class="card p-4 d-none shadow-sm">
    <h5>My Requests</h5>
    <table class="table table-striped mt-2">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>City</th>
          <th>Status</th>
          <th>Matched Seller</th>
        </tr>
      </thead>
      <tbody id="requestsTable"></tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="../firebase-config.js"></script>

<script>
let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    document.getElementById('authSection').classList.add('d-none');
    document.getElementById('requestSection').classList.remove('d-none');
    document.getElementById('myRequests').classList.remove('d-none');
    loadRequests();
  }else{
    currentUser = null;
    document.getElementById('authSection').classList.remove('d-none');
    document.getElementById('requestSection').classList.add('d-none');
    document.getElementById('myRequests').classList.add('d-none');
  }
});

function buyerRegister(){
  auth.createUserWithEmailAndPassword(buyerEmail.value, buyerPassword.value)
    .then(()=>alert("âœ… Registered Successfully"))
    .catch(err=>alert(err.message));
}

function buyerLogin(){
  auth.signInWithEmailAndPassword(buyerEmail.value, buyerPassword.value)
    .then(()=>console.log("Logged in"))
    .catch(err=>alert(err.message));
}

function logout(){ auth.signOut(); }

function submitRequest(){
  const product = reqProduct.value.trim();
  const qty = Number(reqQty.value.trim());
  const city = reqCity.value.trim();

  if(!product || !qty || !city){ alert("Fill all fields"); return; }

  db.collection("requests").add({
    buyerId: currentUser.uid,
    product, qty, city,
    status: "Pending",
    matchedSellerId: null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    reqProduct.value = ""; reqQty.value=""; reqCity.value="";
    alert("âœ… Request submitted");
  });
}





function loadRequests(){
  db.collection("requests")
    .where("buyerId","==",currentUser.uid)
    .orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      const tbody = document.getElementById("requestsTable");
      tbody.innerHTML = "";
      snapshot.forEach(doc=>{
        const r = doc.data();
        let sellerInfo = r.matchedSellerId ? "Seller ID: "+r.matchedSellerId.slice(0,6) : "-";
        tbody.innerHTML += `
          <tr>
            <td>${r.product}</td>
            <td>${r.qty}</td>
            <td>${r.city}</td>
            <td>${r.status}</td>
            <td>${sellerInfo}</td>
          </tr>
        `;
      });
    });
}

</script>
</body>
</html>
