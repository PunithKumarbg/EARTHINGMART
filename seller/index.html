<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Seller | Light Connect</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4 text-success">üè™ Seller Dashboard</h2>

  <!-- Login/Register -->
  <div id="authSection" class="card p-4 mb-4 shadow-sm">
    <h5 class="mb-3 text-center">Login or Register</h5>
    <div class="mb-3">
      <input type="email" id="sellerEmail" class="form-control" placeholder="Email">
    </div>
    <div class="mb-3">
      <input type="password" id="sellerPassword" class="form-control" placeholder="Password">
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-success" onclick="sellerLogin()">Login</button>
      <button class="btn btn-outline-success" onclick="sellerRegister()">Register</button>
    </div>
  </div>

  <!-- Product Listing -->
  <div id="productSection" class="card p-4 mb-4 d-none shadow-sm">
    <h5 class="mb-3">List a Product</h5>
    <div class="mb-2">
      <input type="text" id="productName" class="form-control" placeholder="Product Name">
    </div>
    <div class="mb-2">
      <input type="number" id="productQty" class="form-control" placeholder="Quantity">
    </div>
    <div class="mb-2">
      <input type="number" id="productPrice" class="form-control" placeholder="Price (‚Çπ)">
    </div>
    <div class="mb-2">
      <input type="text" id="productCity" class="form-control" placeholder="City / Delivery Area">
    </div>
    <div class="d-grid">
      <button class="btn btn-success" onclick="addProduct()">Add Product</button>
    </div>
    <div class="text-end mt-3">
      <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- My Products Table -->
  <div id="myProducts" class="card p-4 d-none shadow-sm">
    <h5>My Products</h5>
    <table class="table table-striped mt-3">
      <thead>
        <tr>
          <th>Name</th>
          <th>Qty</th>
          <th>Price</th>
          <th>City</th>
        </tr>
      </thead>
      <tbody id="productsTable"></tbody>
    </table>
  </div>
</div>
<!-- Assigned Requests -->
<div id="assignedRequests" class="card p-4 d-none shadow-sm mt-4">
    <h5>Assigned Requests</h5>
    <table class="table table-striped mt-2">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>City</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="assignedRequestsTable"></tbody>
    </table>
  </div>
  
<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="../firebase-config.js"></script>

<script>
let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('authSection').classList.add('d-none');
    document.getElementById('productSection').classList.remove('d-none');
    document.getElementById('myProducts').classList.remove('d-none');
    loadProducts();
    loadAssignedRequests();  // << add this
  } else {
    currentUser = null;
    document.getElementById('authSection').classList.remove('d-none');
    document.getElementById('productSection').classList.add('d-none');
    document.getElementById('myProducts').classList.add('d-none');
    document.getElementById('assignedRequests').classList.add('d-none');
  }
});

function sellerRegister() {
  const email = sellerEmail.value;
  const pass = sellerPassword.value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(() => alert('‚úÖ Registered Successfully'))
    .catch(err => alert(err.message));
}

function sellerLogin() {
  const email = sellerEmail.value;
  const pass = sellerPassword.value;
  auth.signInWithEmailAndPassword(email, pass)
    .then(() => console.log('Logged In'))
    .catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

function addProduct() {
  const name = productName.value.trim();
  const qty = Number(productQty.value.trim());
  const price = Number(productPrice.value.trim());
  const city = productCity.value.trim();

  if (!name || !qty || !price || !city) {
    alert("‚ö†Ô∏è Please fill all fields");
    return;
  }

  db.collection("sellers").doc(currentUser.uid).set({
    name: currentUser.email,
  }, { merge: true });

  db.collection("sellers").doc(currentUser.uid).collection("products").add({
    name, qty, price, city,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    productName.value = "";
    productQty.value = "";
    productPrice.value = "";
    productCity.value = "";
    alert("‚úÖ Product added");
  });

  loadProducts();
}

function loadProducts() {
  const tbody = document.getElementById('productsTable');
  tbody.innerHTML = '';
  db.collection("sellers").doc(currentUser.uid).collection("products")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      tbody.innerHTML = '';
      snapshot.forEach(doc => {
        const p = doc.data();
        tbody.innerHTML += `
          <tr>
            <td>${p.name}</td>
            <td>${p.qty}</td>
            <td>‚Çπ${p.price}</td>
            <td>${p.city}</td>
          </tr>
        `;
      });
    });
}
function loadAssignedRequests(){
  if(!currentUser) return;

  document.getElementById('assignedRequests').classList.remove('d-none');

  db.collection("SellerAssignedRequests")
    .doc(currentUser.uid)
    .collection("requests")
    .orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      const tbody = document.getElementById("assignedRequestsTable");
      tbody.innerHTML = '';
      snapshot.forEach(doc=>{
        const r = doc.data();
        tbody.innerHTML += `
          <tr>
            <td>${r.product || '-'}</td>
            <td>${r.qty || '-'}</td>
            <td>${r.city || '-'}</td>
            <td>${r.status}</td>
            <td>
              ${r.status === 'Assigned' ? `<button class="btn btn-sm btn-success" onclick="acceptRequest('${doc.id}')">Accept</button>` : '-'}
            </td>
          </tr>
        `;
      });
    });
}

// Accept request
function acceptRequest(requestId){
  const sellerId = currentUser.uid;

  // Update SellerAssignedRequests
  db.collection("SellerAssignedRequests")
    .doc(sellerId)
    .collection("requests")
    .doc(requestId)
    .update({ status: "Accepted" });

  // Update main requests collection (for buyer & admin tracking)
  db.collection("requests")
    .doc(requestId)
    .update({ status: "AcceptedBySeller" })
    .then(()=> alert("‚úÖ Request accepted"));
}

</script>

</body>
</html>
