<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | Light Connect</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4 text-danger">üõ°Ô∏è Admin Dashboard</h2>

  <!-- Admin Login -->
  <div id="authSection" class="card p-4 mb-4 shadow-sm">
    <h5 class="mb-3 text-center">Admin Login</h5>
    <input type="email" id="adminEmail" class="form-control mb-2" placeholder="Email">
    <input type="password" id="adminPassword" class="form-control mb-2" placeholder="Password">
    <button class="btn btn-danger w-100" onclick="adminLogin()">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="d-none">
    <h5>Buyer Requests</h5>
    <table class="table table-striped shadow-sm mt-3">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>City</th>
          <th>Status</th>
          <th>Match Seller</th>
        </tr>
      </thead>
      <tbody id="requestsTable"></tbody>
    </table>
    <div class="text-end mt-3">
      <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="../firebase-config.js"></script>

<script>
let currentUser = null;

firebase.auth().onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    document.getElementById('authSection').classList.add('d-none');
    document.getElementById('dashboard').classList.remove('d-none');
    loadRequests();
  }else{
    currentUser = null;
    document.getElementById('authSection').classList.remove('d-none');
    document.getElementById('dashboard').classList.add('d-none');
  }
});

function adminLogin(){
  firebase.auth().signInWithEmailAndPassword(adminEmail.value, adminPassword.value)
  .then(()=> console.log("Admin Logged In"))
  .catch(err => alert(err.message));
}

function logout(){ firebase.auth().signOut(); }

// Load buyer requests
function loadRequests(){
  db.collection("requests").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    const tbody = document.getElementById("requestsTable");
    tbody.innerHTML = '';
    snapshot.forEach(doc=>{
      const r = doc.data();
      const requestId = doc.id;

      // Get all sellers
      db.collection("sellers").get().then(snapSellers=>{
        let sellerOptions = '';
        snapSellers.forEach(sellerDoc=>{
          const sellerId = sellerDoc.id;
          sellerOptions += `<option value="${sellerId}">${sellerDoc.data().name}</option>`;
        });

        tbody.innerHTML += `
          <tr>
            <td>${r.product}</td>
            <td>${r.qty}</td>
            <td>${r.city}</td>
            <td>${r.status}</td>
            <td>
              <select id="selectSeller_${requestId}" class="form-select form-select-sm mb-1">
                ${sellerOptions}
              </select>
              <button class="btn btn-sm btn-success" onclick="matchSeller('${requestId}')">Match</button>
            </td>
          </tr>
        `;
      });
    });
  });
}

// Match seller to buyer
function matchSeller(requestId){
  const sellerId = document.getElementById(`selectSeller_${requestId}`).value;
  if(!sellerId) return alert("Select a seller first");

  db.collection("requests").doc(requestId).update({
    matchedSellerId: sellerId,
    status: "Matched"
  }).then(()=> alert("‚úÖ Matched successfully"));
}
</script>

</body>
</html>
